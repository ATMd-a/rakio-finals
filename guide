# Comments System Integration Guide

## Overview
This guide explains how to integrate the comments system into your Rakio app.

## Files Created

1. **Content.swift** - Model representing commentable content
2. **ContentService.swift** - Service for fetching content data
3. **CommentHelpers.swift** - Utility functions for comment validation, sorting, and formatting
4. **CommentInputView.swift** - Reusable comment input component
5. **CommentsSectionView.swift** - Complete comments section (alternative to EnhancedCommentsView)

## File Locations

Place these files in your project structure:

```
Rakio/
├── Core/
│   ├── Models/
│   │   └── Domain/
│   │       └── Content.swift
│   └── Services/
│       └── Network/
│           └── ContentService.swift
└── Shared/
    └── Components/
        └── Comments/
            ├── CommentHelpers.swift
            ├── CommentInputView.swift
            └── CommentsSectionView.swift
```

## Usage Examples

### Option 1: Using EnhancedCommentsView (Already in your code)

```swift
// In SeriesDetailView.swift or NovelDetailView.swift
EnhancedCommentsView(
    contentId: series.id ?? "",
    contentType: .shows
)
.padding(.top, 20)
```

### Option 2: Using CommentsSectionView (New alternative)

```swift
// More customizable option
CommentsSectionView(
    contentId: novel.id ?? "",
    contentType: .novels
)
.padding(.horizontal)
```

## Firestore Structure

Your Firestore database should have this structure:

```
firestore/
├── shows/
│   └── {showId}/
│       └── comments/
│           └── {commentId}
│               ├── userId: String
│               ├── username: String
│               ├── text: String
│               ├── timestamp: Timestamp
│               ├── likes: Int
│               └── replies: Array<Reply>
└── novels/
    └── {novelId}/
        └── comments/
            └── {commentId}
                ├── userId: String
                ├── username: String
                ├── text: String
                ├── timestamp: Timestamp
                ├── likes: Int
                └── replies: Array<Reply>
```

## Features Included

### ✅ Core Features
- Post comments
- Delete own comments
- Like comments
- Real-time comment updates
- User authentication checks
- Login prompts for non-authenticated users

### ✅ UI/UX Features
- Character counter (500 char limit)
- Comment validation
- Spam detection
- Sort options (Newest, Oldest, Most Liked)
- Relative timestamps ("2 hours ago")
- Loading states
- Error handling
- Empty states

### ✅ Security Features
- User can only delete their own comments
- Must be logged in to comment
- Input validation and sanitization
- Spam detection

## Validation Rules

The `CommentValidator` enforces:
- Minimum length: 1 character
- Maximum length: 500 characters
- No spam patterns
- No excessive caps lock
- No repeated words

## Customization

### Change Character Limit
```swift
// In CommentValidator.swift
static let maxLength = 1000 // Change from 500
```

### Change Sort Default
```swift
// In CommentsSectionView.swift
@State private var sortOption: CommentSortOption = .mostLiked // Change from .newest
```

### Custom Styling
All colors use your existing theme:
- `Color.rakioPrimary` - Primary accent color
- `Color.rakioBackground` - Background color
- Standard system colors for secondary elements

## Testing

### Test Comment Posting
1. Log in as a user
2. Navigate to a series or novel
3. Scroll to comments section
4. Type a comment and post
5. Verify it appears in Firestore

### Test Comment Deletion
1. Post a comment
2. Click the trash icon on your comment
3. Confirm deletion
4. Verify it's removed from Firestore

### Test Validation
1. Try posting an empty comment (should fail)
2. Try posting a 501-character comment (should truncate)
3. Try posting "test test test test test" (spam detection)

## Common Issues and Solutions

### Issue: Comments not loading
**Solution:** Check that `contentId` is not nil and `contentType` matches your Firestore collection name.

### Issue: Can't delete comments
**Solution:** Verify Firebase Auth is properly configured and user IDs match between auth and comments.

### Issue: Login prompt doesn't work
**Solution:** Ensure LoginView and SignupView are properly imported and accessible.

### Issue: Timestamps show wrong time
**Solution:** Ensure device time is correct and Firestore timestamps are being properly decoded.

## Performance Optimization

### Current Optimizations
- Lazy loading (first 50 comments)
- Optimistic UI updates for likes
- Batched Firestore queries
- Efficient sorting algorithms

### Future Enhancements
- Pagination for large comment sections
- Comment caching
- Real-time listeners for live updates
- Reply threading (UI ready, backend needs implementation)

## Security Rules (Firestore)

Add these rules to your Firestore security rules:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Comments for shows
    match /shows/{showId}/comments/{commentId} {
      allow read: if true;
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.text.size() <= 500;
      allow delete: if request.auth != null 
                    && resource.data.userId == request.auth.uid;
      allow update: if request.auth != null 
                    && resource.data.userId == request.auth.uid;
    }
    
    // Comments for novels
    match /novels/{novelId}/comments/{commentId} {
      allow read: if true;
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.text.size() <= 500;
      allow delete: if request.auth != null 
                    && resource.data.userId == request.auth.uid;
      allow update: if request.auth != null 
                    && resource.data.userId == request.auth.uid;
    }
  }
}
```

## Support

For issues or questions:
1. Check Firestore console for data structure
2. Check Xcode console for error messages
3. Verify user authentication status
4. Test with a fresh user account

## Next Steps

1. Add the files to your Xcode project
2. Update Firestore security rules
3. Test with a real user account
4. Customize styling if needed
5. Consider adding reply functionality (models already support it)

## Reply System (Future Enhancement)

The `Comment` model already includes a `replies` array. To implement:

1. Add reply UI components
2. Update `CommentService` to handle replies
3. Add nested comment display
4. Update Firestore rules for nested paths
